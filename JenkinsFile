pipeline {
    agent any

    environment {
        // Maven command to execute the tests
        MAVEN_CMD = 'mvn clean verify'
        // JDK version defined in your Jenkins tools configuration
        JDK_VERSION = 'jdk17.0.15'
    }

    parameters {
        // Test File Configuration
        string(name: 'TestFolder', defaultValue: 'WireMockNormalGamePlay', description: 'Folder containing the JMeter script files.')
        string(name: 'TestScript', defaultValue: 'WireMockNormalGamePlayTestPlan.jmx', description: 'The specific .jmx script to execute.')

        // Host Configuration
        string(name: 'Protocol', defaultValue: 'http', description: 'Protocol to be used for the test (http/https).')
        string(name: 'BaseUrl', defaultValue: 'localhost', description: 'Base URL of the application under test.')
        string(name: 'Port', defaultValue: '8990', description: 'Port number of the application under test.')

        // Load Profile Configuration (Thread Group/Concurrency Group)
        string(name: 'RampUpTime', defaultValue: '60', description: 'Total Ramp-up time in seconds for all users.')
        string(name: 'RampUpSteps', defaultValue: '60', description: 'Ramp-up Step Count (used for concurrency thread groups).')
        string(name: 'TestDuration', defaultValue: '300', description: 'Duration of the steady-state test in seconds.')
        string(name: 'RampDownTime', defaultValue: '60', description: 'Ramp-down time in seconds.')

        // Throughput Shaping / Advanced Configuration
        string(name: 'StartRPS', defaultValue: '100', description: 'Starting Requests Per Second (RPS) for throughput control.')
        string(name: 'SteadyStateRPS', defaultValue: '100', description: 'Target steady-state Requests Per Second (RPS).')
        string(name: 'EndRPS', defaultValue: '100', description: 'Ending Requests Per Second (RPS).')
        string(name: 'NumberOfGamesPerPlayer', defaultValue: '100', description: 'No. of Games per Player (maps to test.gamesPerPlayer).')
    }

    tools {
        maven 'Maven 3.9.11' // Ensure this matches your Jenkins tool configuration
        jdk env.JDK_VERSION
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out the repository...'
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                echo 'Setting up the environment for performance tests...'
                // Running 'mvn clean' here is redundant as MAVEN_CMD includes it, but kept for clarity/quick setup.
                bat 'mvn clean'
                // OPTIONAL: Purge the local Maven cache for the JMeter plugin
                echo 'Cleaning local Maven cache for JMeter dependencies...'
                bat 'mvn dependency:purge-local-repository -DmanualIncludes=com.lazerycode.jmeter'
            }
        }

        stage('Run Performance Tests') {
            steps {
                echo 'Executing JMeter Performance Tests for WireMockNormalGamePlay...'
                echo """
                Test Folder: ${params.TestFolder}
                Test Script: ${params.TestScript}
                Protocol: ${params.Protocol}
                Base URL: ${params.BaseUrl}
                Port: ${params.Port}
                Ramp-up Time: ${params.RampUpTime}s
                Ramp-up Steps: ${params.RampUpSteps}
                Test Duration: ${params.TestDuration}s
                Ramp-down Time: ${params.RampDownTime}s
                Start RPS: ${params.StartRPS}
                Steady-State RPS: ${params.SteadyStateRPS}
                End RPS: ${params.EndRPS}
                Number of Games per Player: ${params.NumberOfGamesPerPlayer}
                """
                sh """
                   $MAVEN_CMD \
                       -Dtest.folder=${params.TestFolder} \
                       -Dtest.script=${params.TestScript} \
                       -Dtest.protocol=${params.Protocol} \
                       -Dtest.baseUrl=${params.BaseUrl} \
                       -Dtest.port=${params.Port} \
                       -Dtest.rampUpTime=${params.RampUpTime} \
                       -Dtest.rampUpStepCount=${params.RampUpSteps} \
                       -Dtest.testDuration=${params.TestDuration} \
                       -Dtest.rampDownTime=${params.RampDownTime} \
                       -Dtest.startRPS=${params.StartRPS} \
                       -Dtest.steadyStateRPS=${params.SteadyStateRPS} \
                       -Dtest.endRPS=${params.EndRPS} \
                       -Dtest.NoOfGamesPerPlayer=${params.NumberOfGamesPerPlayer} \
                   """
            }
        }


        stage('Publish Reports') {
            steps {
                echo 'Publishing JMeter Performance Test Results...'
                // Check if the CSV results exist
                sh 'ls -l target/jmeter/results/*.csv'
                // Check if the HTML report directory exists
                sh 'ls -l target/jmeter/reports/'
                // Archive the generated CSV results
                archiveArtifacts artifacts: 'target/jmeter/results/*.csv', allowEmptyArchive: true
                // Archive generated HTML report directory
                archiveArtifacts artifacts: 'target/jmeter/reports/**/*', allowEmptyArchive: true
                // Archive JMeter logs
                archiveArtifacts artifacts: 'target/jmeter/logs/*.log', allowEmptyArchive: true

            }
        }
    }

    post {
        always {
            echo 'Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo 'Performance pipeline executed successfully!'
        }
        failure {
            echo 'Performance pipeline execution failed! Please review the logs for more details.'
        }
    }
}
